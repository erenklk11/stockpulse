// Declarative Jenkinsfile for StockPulse Project
// Local Jenkins deployment to Azure Cloud
// This pipeline runs locally but deploys to Azure cloud services

pipeline {
    agent any

    environment {
        DOCKERHUB_USERNAME = 'erenklk11'
        SPRING_APP_IMAGE = "${env.DOCKERHUB_USERNAME}/stockpulse-backend"
        IMAGE_TAG = "build-${env.BUILD_NUMBER}"

        AZURE_WEBAPP_NAME = 'stockpulse-backend'
        AZURE_STATIC_WEB_APP_NAME = 'stockpulse-frontend'
        AZURE_RESOURCE_GROUP = 'stockpulse-rg'
        AZURE_APP_SERVICE_PLAN = 'stockpulse-appservice-plan'

        DOCKER_REGISTRY_URL = 'https://index.docker.io/v1/'

        MAVEN_OPTS = '-Xmx1024m'
        NODE_OPTIONS = '--max_old_space_size=4096'
    }

    stages {
        stage('Checkout') {
            steps {
                script {
                    echo 'üì• Checking out source code...'
                    git branch: 'main', url: 'https://github.com/erenklk11/stockpulse.git'
                }
            }
        }

        stage('Build & Test Backend') {
            steps {
                script {
                    echo 'üî® Building and testing Spring Boot backend...'
                    dir('backend') {
                        sh './mvnw clean test'
                        sh './mvnw clean package -DskipTests'
                    }
                }
            }
            post {
                always {
                    dir('backend') {
                        publishTestResults testResultsPattern: 'target/surefire-reports/*.xml'
                    }
                }
            }
        }

        stage('Build Frontend') {
            agent {
                docker {
                    image 'node:18-alpine'
                    args '-u root'
                }
            }
            steps {
                script {
                    echo 'üî® Building Angular frontend...'
                    dir('frontend') {
                        sh 'npm ci'
                        sh 'npm run test -- --browsers=ChromeHeadless --watch=false'
                        sh 'npm run build -- --configuration production'
                        archiveArtifacts artifacts: 'dist/**/*', allowEmptyArchive: false
                    }
                }
            }
        }

        stage('Build Backend Docker Image') {
            steps {
                script {
                    echo 'üê≥ Building Docker image for Spring Boot backend...'
                    dir('backend') {
                        def backendImage = docker.build("${SPRING_APP_IMAGE}:${IMAGE_TAG}")
                        backendImage.tag("${SPRING_APP_IMAGE}:latest")
                    }
                }
            }
        }

        stage('Push Docker Image') {
            steps {
                script {
                    echo 'üì§ Pushing Docker images to registry...'
                    withCredentials([usernamePassword(credentialsId: 'dockerhub-credentials-id',
                                                    usernameVariable: 'DOCKER_USER',
                                                    passwordVariable: 'DOCKER_PASS')]) {
                        sh 'echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin'
                        sh "docker push ${SPRING_APP_IMAGE}:${IMAGE_TAG}"
                        sh "docker push ${SPRING_APP_IMAGE}:latest"
                    }
                }
            }
        }

        stage('Deploy Backend to Azure') {
            steps {
                script {
                    echo 'üöÄ Deploying backend to Azure Web App for Containers...'
                    withCredentials([
                        usernamePassword(credentialsId: 'azure-service-principal',
                                         usernameVariable: 'AZURE_CLIENT_ID',
                                         passwordVariable: 'AZURE_CLIENT_SECRET'),
                        string(credentialsId: 'azure-tenant-id', variable: 'AZURE_TENANT_ID'),
                        string(credentialsId: 'azure-subscription-id', variable: 'AZURE_SUBSCRIPTION_ID'),
                        usernamePassword(credentialsId: 'dockerhub-credentials-id',
                                       usernameVariable: 'DOCKER_REGISTRY_USER',
                                       passwordVariable: 'DOCKER_REGISTRY_PASSWORD')
                    ]) {
                        sh 'az login --service-principal -u $AZURE_CLIENT_ID -p $AZURE_CLIENT_SECRET -t $AZURE_TENANT_ID'
                        sh "az account set --subscription $AZURE_SUBSCRIPTION_ID"

                        // Create Web App if it doesn't exist (idempotent)
                        sh """
                            az webapp create \
                                --resource-group ${AZURE_RESOURCE_GROUP} \
                                --plan ${AZURE_APP_SERVICE_PLAN} \
                                --name ${AZURE_WEBAPP_NAME} \
                                --deployment-container-image-name ${SPRING_APP_IMAGE}:${IMAGE_TAG} \
                                --runtime "JAVA|17-java17" || echo "Web App already exists"
                        """

                        // Update container image for existing Web App
                        sh """
                            az webapp config container set \
                                --resource-group ${AZURE_RESOURCE_GROUP} \
                                --name ${AZURE_WEBAPP_NAME} \
                                --docker-custom-image-name ${SPRING_APP_IMAGE}:${IMAGE_TAG} \
                                --docker-registry-server-url ${DOCKER_REGISTRY_URL} \
                                --docker-registry-server-user \$DOCKER_REGISTRY_USER \
                                --docker-registry-server-password \$DOCKER_REGISTRY_PASSWORD
                        """

                        // Restart app so new container is picked up
                        sh """
                            az webapp restart \
                                --name ${AZURE_WEBAPP_NAME} \
                                --resource-group ${AZURE_RESOURCE_GROUP}
                        """
                    }
                }
            }
        }

        stage('Deploy Frontend to Azure Static Web Apps') {
            steps {
                script {
                    echo 'üöÄ Deploying frontend to Azure Static Web Apps...'
                    withCredentials([
                        usernamePassword(credentialsId: 'azure-service-principal',
                                         usernameVariable: 'AZURE_CLIENT_ID',
                                         passwordVariable: 'AZURE_CLIENT_SECRET'),
                        string(credentialsId: 'azure-tenant-id', variable: 'AZURE_TENANT_ID'),
                        string(credentialsId: 'azure-subscription-id', variable: 'AZURE_SUBSCRIPTION_ID')
                    ]) {
                        dir('frontend') {
                            sh 'az login --service-principal -u $AZURE_CLIENT_ID -p $AZURE_CLIENT_SECRET -t $AZURE_TENANT_ID'
                            sh "az account set --subscription $AZURE_SUBSCRIPTION_ID"

                            sh """
                                az staticwebapp deploy \\
                                    --name ${AZURE_STATIC_WEB_APP_NAME} \\
                                    --resource-group ${AZURE_RESOURCE_GROUP} \\
                                    --source-location dist/stockpulse-frontend \\
                                    --output-location dist/stockpulse-frontend
                            """
                        }
                    }
                }
            }
        }

        stage('Health Check') {
            steps {
                script {
                    echo 'üè• Performing health checks...'
                    sleep time: 30, unit: 'SECONDS'

                    // Backend health check using the deployed Web App URL
                    sh """
                        backend_url="https://${AZURE_WEBAPP_NAME}.azurewebsites.net/actuator/health"
                        echo "Checking backend health at: \$backend_url"
                        curl -f \$backend_url || exit 1
                    """

                    // Frontend health check
                    sh """
                        frontend_url="https://${AZURE_STATIC_WEB_APP_NAME}.azurestaticapps.net"
                        echo "Checking frontend availability at: \$frontend_url"
                        curl -f \$frontend_url || exit 1
                    """
                }
            }
        }
    }

    post {
        always {
            echo 'üßπ Cleaning up workspace...'
            cleanWs()
        }

        success {
            echo '‚úÖ Deployment successful!'
            script {
                emailext (
                    subject: "‚úÖ StockPulse Deployment Successful - Build #${env.BUILD_NUMBER}",
                    body: """
                        <h2>Deployment Successful!</h2>
                        <p><strong>Build Number:</strong> ${env.BUILD_NUMBER}</p>
                        <p><strong>Backend Image:</strong> ${SPRING_APP_IMAGE}:${IMAGE_TAG}</p>
                        <p><strong>Frontend URL:</strong> https://${AZURE_STATIC_WEB_APP_NAME}.azurestaticapps.net</p>
                        <p><strong>Backend API:</strong> https://${AZURE_WEBAPP_NAME}.azurewebsites.net</p>
                    """,
                    to: 'erenklk11@gmail.com',
                    mimeType: 'text/html'
                )
            }
        }

        failure {
            echo '‚ùå Deployment failed!'
            script {
                emailext (
                    subject: "‚ùå StockPulse Deployment Failed - Build #${env.BUILD_NUMBER}",
                    body: """
                        <h2>Deployment Failed!</h2>
                        <p><strong>Build Number:</strong> ${env.BUILD_NUMBER}</p>
                        <p><strong>Console Output:</strong> ${env.BUILD_URL}console</p>
                        <p>Please check the logs for more details.</p>
                    """,
                    to: 'erenklk11@gmail.com',
                    mimeType: 'text/html'
                )
            }
        }

        unstable {
            echo '‚ö†Ô∏è Build unstable - some tests may have failed'
        }
    }
}
